<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Anggota - Koperasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <div class="max-w-lg mx-auto p-4 py-8">
        <div class="bg-white rounded-3xl shadow-2xl p-6 relative">

            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-blue-600 flex items-center gap-2 uppercase tracking-tighter">
                    üë§ Profil Saya
                </h3>
                <div class="flex gap-2">
                    <button onclick="changePassword()"
                        class="text-[10px] font-bold bg-amber-100 text-amber-600 px-3 py-1 rounded-full border border-amber-200 hover:bg-amber-200 transition-all">
                        üîë GANTI PASS
                    </button>
                    <button onclick="logout()"
                        class="text-[10px] font-bold bg-red-100 text-red-600 px-3 py-1 rounded-full">LOGOUT
                    </button>
                </div>
            </div>

            <div id="detailContent" class="space-y-4 text-left">
                <div class="flex justify-center items-center p-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
            </div>

            <div class="mt-8 border-t border-gray-100 pt-6 pb-4">
                <div class="flex flex-col items-center gap-2">
                    <p class="text-[9px] text-center text-gray-400 font-bold uppercase tracking-[0.3em]">
                        Developed by
                        <span class="text-blue-500/90 transition-all duration-700 hover:text-cyan-400"
                            style="text-shadow: 0 0 10px rgba(59, 130, 246, 0.4);">
                            PutragungCyber_Dev
                        </span>
                        - 2026
                    </p>

                    <a href="https://wa.me/6281977385582" target="_blank"
                        class="flex items-center gap-1.5 text-[8px] font-black bg-white text-gray-500 px-3 py-1 rounded-full border border-gray-200 shadow-sm hover:border-emerald-400 hover:text-emerald-600 hover:bg-emerald-50 transition-all duration-300">
                        <i class="fab fa-whatsapp text-[10px]"></i>
                        <span>HUBUNGI DEVELOPER: 0819-7738-5582</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div id="modalBukuKendali"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[9999] flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-2xl rounded-3xl overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-300 flex flex-col max-h-[90vh]">

            <div class="p-6 border-b flex justify-between items-center bg-gray-50 flex-shrink-0">
                <h3 class="font-black text-amber-800 flex items-center gap-2">üìñ BUKU KENDALI IURAN WAJIB</h3>
                <button onclick="tutupBukuKendali()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-wider transition-colors">Tutup</button>
            </div>

            <div class="p-6 bg-white border-b flex gap-3 flex-shrink-0">
                <select id="lapTahun"
                    class="flex-1 bg-gray-100 border-none rounded-xl px-4 py-3 font-bold text-gray-700 focus:ring-2 focus:ring-amber-500"></select>
                <button onclick="renderBukuKendaliSaya()"
                    class="bg-amber-500 hover:bg-amber-600 text-white px-8 py-3 rounded-xl font-black transition-all shadow-md active:scale-95">PROSES</button>
            </div>

            <div class="grid grid-cols-2 gap-4 p-6 bg-gray-50 flex-shrink-0">
                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                    <p class="text-[10px] uppercase font-bold text-emerald-600 mb-1">Total Lunas</p>
                    <p id="statLunas" class="text-xl font-black text-emerald-700">Rp 0</p>
                </div>
                <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                    <p class="text-[10px] uppercase font-bold text-red-600 mb-1">Tunggakan</p>
                    <p id="statTunggakan" class="text-xl font-black text-red-700">Rp 0</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-0 border-t pb-20">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0 z-10">
                        <tr class="text-[10px] uppercase text-gray-500 font-bold">
                            <th class="px-6 py-4">Bulan</th>
                            <th class="px-6 py-4 text-center">Status</th>
                            <th class="px-6 py-4 text-right">Nominal</th>
                        </tr>
                    </thead>
                    <tbody id="tabelKendaliBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>

        </div>
    </div>

    <script>
        const API_BASE_URL = ''; // Tambahkan ini agar variabelnya terdefinisi
        let idAnggota; // Deklarasikan di atas agar bisa dibaca fungsi lihatRiwayat
        // 1. AMBIL ID DARI SESSION SAAT HALAMAN DIBUKA
        // Karena ini 'anggota.html', kita asumsikan server ngasih data user yang login
        document.addEventListener('DOMContentLoaded', async () => {
            await muatProfilMandiri();
        });

        function formatTglIndo(tgl, tipe = '') {
            if (!tgl) return '-';
            const d = new Date(tgl);
            const opsi = { day: 'numeric', month: 'short', year: 'numeric' };
            const tanggal = d.toLocaleDateString('id-ID', opsi);
            const jam = d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            return tipe === 'jam' ? `${tanggal} ${jam}` : tanggal;
        }

        // Copy fungsi ini biar standar kayak index.html tapi khusus ambil angka
        const getAngkaTanggal = (dateStr) => {
            const d = new Date(dateStr);
            // Jika tanggal ga valid, kasih default tahun berdiri koperasi
            if (isNaN(d.getTime())) return { thn: 2013, bln: 1 };
            return {
                thn: d.getFullYear(),
                bln: d.getMonth() + 1
            };
        };

        async function muatProfilMandiri() {
            try {
                const response = await fetch('/api/cek-sesi-anggota');

                // Cek dulu ok atau nggak, baru ambil json-nya
                if (!response.ok) {
                    window.location.href = '/login.html'; // Tambahkan .html jika perlu
                    return;
                }

                const session = await response.json();

                const res = await fetch(`/api/anggota-detail/${session.id_anggota}`);
                const data = await res.json();

                if (res.ok) {
                    idAnggota = data.id_anggota;
                    showDetail(data);
                }
            } catch (err) {
                console.error("Gagal sinkronisasi:", err);
            }
        }

        // 2. FUNGSI "OTAK" (Plek Ketiplek punya Lu)
        function showDetail(d) {
            // --- LOGIKA HITUNG TUNGGAKAN (REVISI HISTORI) ---
            const tglGabung = d.tgl_bergabung ? new Date(d.tgl_bergabung) : new Date();
            const skrg = new Date();

            let totalHarusnya = 0;
            let tempTgl = new Date(tglGabung);
            tempTgl.setDate(1);

            while (tempTgl <= skrg) {
                let bln = tempTgl.getMonth() + 1;
                let thn = tempTgl.getFullYear();
                totalHarusnya += (thn < 2022 || (thn === 2022 && bln < 7)) ? 10000 : 20000;
                tempTgl.setMonth(tempTgl.getMonth() + 1);
            }

            const selisihBulan = (skrg.getFullYear() - tglGabung.getFullYear()) * 12 + (skrg.getMonth() - tglGabung.getMonth()) + 1;
            const sudahBayarBulan = parseInt(d.total_lunas_wajib || 0);
            const nunggakBulan = Math.max(0, selisihBulan - sudahBayarBulan);
            const nunggakNominal = Math.max(0, totalHarusnya - parseInt(d.total_simpanan_wajib_saja || 0));
            const saldoSimpanan = parseInt(d.total_simpanan || 0);

            const boxColor = nunggakBulan > 0 ? "bg-red-50 border-red-100" : "bg-emerald-50 border-emerald-100";
            const textColor = nunggakBulan > 0 ? "text-red-700" : "text-emerald-700";
            const labelColor = nunggakBulan > 0 ? "text-red-400" : "text-emerald-400";

            const tglGabungIndo = d.tgl_bergabung ? new Date(d.tgl_bergabung).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
            const part = (d.ttl || "").split(", ");
            const tempat = part[0] || "-";
            const tglLahirMentah = part[1] || "";
            const tglLahirIndo = tglLahirMentah ? new Date(tglLahirMentah).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : "";
            const ttlCantik = tglLahirIndo !== "" ? `${tempat}, ${tglLahirIndo}` : tempat;

            document.getElementById('detailContent').innerHTML = `
                <div id="viewMode" class="space-y-4">
                    <div class="bg-blue-600 p-5 rounded-2xl text-white shadow-lg mb-4">
                        <p class="text-[10px] font-black uppercase opacity-80">Nama Lengkap Anggota</p>
                        <p class="font-bold text-2xl tracking-tight leading-tight">${d.nama_lengkap}</p>
                        <div class="mt-2 inline-block bg-white/20 px-3 py-1 rounded-full text-[10px] font-bold">ID: ${d.no_anggota}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 p-4 rounded-2xl border ${boxColor} shadow-inner">
                        <div>
                            <p class="text-[9px] font-black ${labelColor} uppercase">Tunggakan Iuran</p>
                            <p class="text-xl font-black ${textColor}">${nunggakBulan} <span class="text-xs font-bold">Bulan</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-black ${labelColor} uppercase">Total Tagihan</p>
                            <p class="text-xl font-black ${textColor}">Rp${nunggakNominal.toLocaleString('id-ID')}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="p-3 rounded-2xl border border-emerald-100 bg-emerald-50 shadow-sm">
                            <p class="text-[9px] font-black text-emerald-400 uppercase">Saldo Simpanan</p>
                            <p class="text-lg font-black text-emerald-700">Rp${saldoSimpanan.toLocaleString('id-ID')}</p>
                            <p class="text-[10px] font-bold text-emerald-600 opacity-70">Wajib + Sukarela</p>
                        </div>
                        <div class="flex items-stretch">
                            <button disabled title="Next Feature-PutragungCyber_Dev"
                                class="w-full bg-gray-300 text-gray-500 rounded-2xl text-[10px] font-black shadow-none flex flex-col justify-center items-center gap-1 cursor-not-allowed opacity-80">
                                <span class="text-lg grayscale">üí∏</span>
                                <span>WITHDRAWAL</span>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="p-3 bg-gray-50 rounded-xl border">
                            <p class="text-[9px] font-black text-gray-400 uppercase">Tempat, Tanggal Lahir</p>
                            <p class="font-bold text-gray-700">${ttlCantik}</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-xl border">
                            <p class="text-[9px] font-black text-gray-400 uppercase">Alamat Lengkap</p>
                            <p class="text-sm text-gray-600 leading-relaxed">${d.alamat || '-'}</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 flex justify-between items-center">
                            <div>
                                <p class="text-[9px] font-black text-blue-400 uppercase">Tanggal Bergabung</p>
                                <p class="font-bold text-blue-800">${tglGabungIndo}</p>
                            </div>
                            <span class="bg-emerald-500 text-white text-[10px] px-3 py-1 rounded-full font-bold shadow-sm">AKTIF</span>
                        </div>
                        <div id="areaRiwayat" class="hidden mt-4"></div>
                    </div>

                    <div id="profilView" class="space-y-4"> 
                        <div class="grid grid-cols-3 gap-2 pt-4 border-t">
                            <button onclick="enableEditMode()" class="bg-amber-500 text-white py-2 rounded-xl font-bold text-[10px] shadow-md">‚úèÔ∏è EDIT PROFILE</button>
                            <button disabled title="next feature-PutragungCyber_Dev" class="bg-gray-300 text-gray-500 py-2 rounded-xl font-bold text-[10px] cursor-not-allowed">‚ûï IURAN</button>
                        </div>
                    </div>

                    <div id="profilEdit" class="hidden">
                        </div>

                    <button onclick="lihatRiwayat(idAnggota)"class="w-full bg-blue-700 text-white py-3 rounded-xl font-black text-sm shadow-lg mt-2">
                        üìú LIHAT SEMUA RIWAYAT
                    </button>
                    <button onclick="bukaBukuKendali()" class="w-full bg-gradient-to-r from-orange-400 to-amber-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:scale-[1.02] transition-all flex items-center justify-center gap-2 mt-4">
                        üìñ <span>BUKU KENDALI IURAN WAJIB</span>
                    </button>
                </div>
            `;
        }
        async function lihatRiwayat(id) { // Nama variabel di sini adalah 'id'
            const area = document.getElementById('areaRiwayat');

            // LOGIKA TOGGLE
            if (!area.classList.contains('hidden')) {
                area.classList.add('hidden');
                return;
            }

            area.innerHTML = '<p class="text-center text-[10px] animate-pulse py-4">Loading...</p>';
            area.classList.remove('hidden');

            try {
                // PERBAIKAN: Ganti ${idAnggota} jadi ${id} agar sesuai dengan parameter di atas
                const res = await fetch(`${API_BASE_URL}/riwayat-iuran/${id}`);
                const data = await res.json();

                let html = `
            <div class="bg-white border-2 border-blue-100 rounded-2xl overflow-hidden shadow-inner mb-4 max-h-[400px] overflow-y-auto">
                <div class="bg-blue-50 p-2 text-[9px] font-bold text-blue-600 flex justify-between uppercase sticky top-0 z-20">
                    <span>Log Transaksi</span>
                    <span>Klik tombol Riwayat lagi untuk tutup</span>
                </div>
                <table class="min-w-full text-[10px] relative">
                    <thead class="bg-gray-100 border-b text-gray-400 sticky top-[25px] z-10 shadow-sm">
                        <tr>
                            <th class="p-2 text-left bg-gray-50">Tgl Input</th>
                            <th class="p-2 text-left bg-gray-50">Periode</th>
                            <th class="p-2 text-right bg-gray-50">Jumlah</th>
                        </tr>
                    </thead>
                <tbody class="divide-y">`;

                data.forEach(t => {
                    const tglSistem = formatTglIndo(t.created_at, 'jam');
                    const nominal = parseFloat(t.jumlah_bayar) || 0;

                    // LOGIKA WARNA & SIMBOL
                    // Kalau nominal minus (< 0), teks jadi merah (rose-600)
                    // Kalau nominal plus (>= 0), teks tetap hijau (emerald-600)
                    const warnaTeks = nominal < 0 ? 'text-rose-600' : 'text-emerald-600';

                    // Kita rapikan tampilannya: Kalau minus, kasih tanda "-" di depan Rp
                    const teksNominal = (nominal < 0 ? '-' : '') + `Rp${Math.abs(nominal).toLocaleString('id-ID')}`;

                    html += `
                <tr class="hover:bg-blue-50">
                    <td class="p-2 text-gray-400 font-mono">${tglSistem}</td>
                    <td class="p-2 font-bold">
                        ${t.bulan_iuran}/${t.tahun_iuran} 
                        <span class="text-[8px] text-gray-400">(${t.jenis_iuran})</span>
                        ${nominal < 0 ? '<br><span class="text-[9px] text-rose-500 font-black">PENGAMBILAN</span>' : ''}
                    </td>
                    <td class="p-2 text-right font-bold ${warnaTeks}">
                        ${teksNominal}
                    </td>
                </tr>`;
                });

                html += `</tbody></table></div>`;
                area.innerHTML = html;

                area.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (e) {
                // Sekarang kalau gagal, kita bisa tau errornya di console (F12)
                console.error("Detail Error Riwayat:", e);
                area.innerHTML = '<p class="text-red-500 text-xs text-center">Gagal load data. Cek koneksi API.</p>';
            }
        }

        // Tambahkan di dalam <script>
        function bukaBukuKendali() {
            const modal = document.getElementById('modalBukuKendali');
            modal.classList.remove('hidden');

            const sel = document.getElementById('lapTahun');
            if (sel.options.length === 0) {
                const now = new Date().getFullYear();
                for (let i = now + 1; i >= 2013; i--) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `TAHUN ${i}`;
                    if (i === now) opt.selected = true;
                    sel.appendChild(opt);
                }
            }
            renderBukuKendaliSaya();
        }

        function tutupBukuKendali() {
            document.getElementById('modalBukuKendali').classList.add('hidden');
        }

        async function renderBukuKendaliSaya() {
            const thnInput = document.getElementById('lapTahun').value;
            const thn = parseInt(thnInput); // Pastikan jadi ANGKA
            const tbody = document.getElementById('tabelKendaliBody');
            const now = new Date();
            const blnBerjalan = now.getMonth() + 1;
            const thnBerjalan = now.getFullYear();

            tbody.innerHTML = '<tr><td colspan="3" class="p-10 text-center animate-pulse text-amber-500 font-bold">Memuat Data...</td></tr>';

            try {
                const [resMe, resLaporan] = await Promise.all([
                    fetch('/api/auth/me'),
                    fetch(`/api/laporan-transaksi?tahun=${thn}&v=${Date.now()}`)
                ]);

                const me = await resMe.json();
                const responseJson = await resLaporan.json();
                const dataTrans = responseJson.transaksi;

                const infoGabung = getAngkaTanggal(me.tgl_bergabung);
                const thnGabung = infoGabung.thn;
                const blnGabung = infoGabung.bln;

                let html = '';
                let totalLunas = 0;
                let totalTunggakan = 0;

                const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

                namaBulan.forEach((nama, i) => {
                    const b = i + 1;

                    // --- START PERBAIKAN LOGIKA ---

                    // 1. Cari data lunas milik user ini
                    const ada = dataTrans.find(t =>
                        String(t.id_anggota) === String(me.id_anggota) &&
                        parseInt(t.bulan_iuran) === b &&
                        t.jenis_iuran === 'wajib'
                    );

                    let status = '-', gaya = 'text-gray-300', nominal = 'Rp 0';

                    // 2. Logika Status Keanggotaan (PENTING)
                    // Belum Gabung: Jika tahun yang dilihat < tahun gabung, ATAU tahun sama tapi bulan belum sampai
                    const belumGabung = (thn < thnGabung) || (thn === thnGabung && b < blnGabung);

                    // Sudah Wajib: Jika tahun yang dilihat > tahun gabung, ATAU tahun sama dan sudah masuk bulan gabung
                    const sudahWajib = (thn > thnGabung) || (thn === thnGabung && b >= blnGabung);

                    // Logika Waktu Kalender: Tahun/Bulan tersebut sudah terlewati di dunia nyata
                    const sudahLewatWaktu = (thn < thnBerjalan) || (thn === thnBerjalan && b <= blnBerjalan);

                    if (ada) {
                        // KONDISI LUNAS
                        status = 'LUNAS';
                        gaya = 'text-emerald-600 font-black bg-emerald-50 rounded-lg px-2 py-1';
                        nominal = `Rp ${parseFloat(ada.jumlah_bayar).toLocaleString('id-ID')}`;
                        totalLunas += parseFloat(ada.jumlah_bayar);
                    }
                    else if (belumGabung) {
                        // KONDISI SEBELUM BERGABUNG (Data tidak ada dan memang belum jadi anggota)
                        status = 'N/A';
                        gaya = 'text-gray-400 italic font-medium';
                        nominal = 'Rp 0';
                    }
                    else if (sudahWajib && sudahLewatWaktu) {
                        // KONDISI NUNGGAK (Sudah wajib bayar tapi data tidak ditemukan)
                        status = 'NUNGGAK';
                        gaya = 'text-red-500 font-black bg-red-50 rounded-lg px-2 py-1';

                        // Penyesuaian tarif historis
                        const tagihan = (thn < 2022 || (thn === 2022 && b <= 6)) ? 10000 : 20000;
                        nominal = `Rp ${tagihan.toLocaleString('id-ID')}`;
                        totalTunggakan += tagihan;
                    }

                    // --- END PERBAIKAN LOGIKA ---
                    html += `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 font-bold text-gray-600 text-sm">${nama}</td>
                    <td class="px-6 py-4 text-center text-[10px]"><span class="${gaya}">${status}</span></td>
                    <td class="px-6 py-4 text-right font-mono text-sm text-gray-700">${nominal}</td>
                </tr>`;
                });

                // Tambahan "Bantalan" agar baris Desember tidak menempel ke bawah
                html += `
            <tr class="h-24">
                <td colspan="3" class="text-center text-[10px] text-gray-400 font-bold tracking-widest pt-10">
                    --- AKHIR LAPORAN ${thn} ---
                </td>
            </tr>`;

                tbody.innerHTML = html;
                document.getElementById('statLunas').textContent = `Rp ${totalLunas.toLocaleString('id-ID')}`;
                document.getElementById('statTunggakan').textContent = `Rp ${totalTunggakan.toLocaleString('id-ID')}`;

            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="3" class="p-10 text-center text-red-500">Gagal memuat data</td></tr>';
            }
            // Debugging (opsional, cek di console F12)
            console.log(`Anggota gabung: Bulan ${blnGabung} Tahun ${thnGabung}`);
        }


        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST', // WAJIB POST sesuai index.js lu
                    headers: { 'Content-Type': 'application/json' }
                });

                const hasil = await response.json();
                if (hasil.success) {
                    // Hapus jejak di browser dan balik ke login
                    window.location.href = '/login.html';
                }
            } catch (err) {
                console.error("Gagal logout:", err);
                // Tetap paksa pindah jika error
                window.location.href = '/login.html';
            }
        }

        // Global variable untuk simpan data user pas lagi edit
        let currentUserData = null;

        // Fungsi Edit Profile
        async function enableEditMode() {
            try {
                // Ambil data terbaru dulu
                const res = await fetch('/api/auth/me');
                const d = await res.json();
                currentUserData = d; // Simpan ke global buat referensi saat save

                // Sembunyikan view, munculkan edit
                const viewArea = document.getElementById('profilView'); // Tadinya 'viewMode'
                const editArea = document.getElementById('profilEdit'); // Tadinya 'editMode'

                if (viewArea && editArea) {
                    viewArea.classList.add('hidden');
                    editArea.classList.remove('hidden');
                } else {
                    console.error("Waduh, ID profilView atau profilEdit nggak ketemu di HTML!");
                    return;
                }
                // Split tempat & tgl lahir (Format: "Jakarta, 1990-01-01")
                let part = (d.ttl || "").split(", ");
                let tempat = part[0] || "";
                let tglLahirMentah = part[1] || "";

                // Helper format tanggal buat input (biasanya input date butuh YYYY-MM-DD)
                const toInputDate = (str) => {
                    if (!str) return "";
                    const dt = new Date(str);
                    return isNaN(dt) ? "" : dt.toISOString().split('T')[0];
                };

                editArea.innerHTML = `
        <h4 class="text-amber-600 font-black mb-4 border-b pb-2 uppercase tracking-tighter text-left">Update Profil Saya</h4>
        <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scroll">
            <input type="hidden" id="edit_no_anggota" value="${d.no_anggota}">
            
            <div class="text-left">
                <label class="text-[10px] font-bold text-gray-400 uppercase">Nama Lengkap</label>
                <input type="text" id="edit_nama" class="w-full border p-3 rounded-xl bg-gray-50 focus:ring-2 focus:ring-amber-500 outline-none" value="${d.nama_lengkap || ''}">
            </div>

            <div class="grid grid-cols-2 gap-2 text-left">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">NIK</label>
                    <input type="text" id="edit_nik" class="w-full border p-3 rounded-xl bg-gray-50" value="${d.nik || ''}">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">No HP (WhatsApp)</label>
                    <input type="text" id="edit_no_hp" class="w-full border p-3 rounded-xl bg-gray-50" value="${d.no_hp || ''}">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-left">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Jenis Kelamin</label>
                    <select id="edit_jk" class="w-full border p-3 rounded-xl bg-gray-50">
                        <option value="Laki-laki" ${d.jenis_kelamin === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                        <option value="Perempuan" ${d.jenis_kelamin === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Pekerjaan</label>
                    <input type="text" id="edit_pekerjaan" class="w-full border p-3 rounded-xl bg-gray-50" value="${d.pekerjaan || ''}">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-left">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Tempat Lahir</label>
                    <input type="text" id="edit_tempat" class="w-full border p-3 rounded-xl bg-gray-50" value="${tempat}">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Tgl Lahir</label>
                    <input type="date" id="edit_tgl_lahir" class="w-full border p-3 rounded-xl bg-gray-50" value="${toInputDate(tglLahirMentah)}">
                </div>
            </div>

            <div class="text-left">
                <label class="text-[10px] font-bold text-gray-400 uppercase">Alamat Lengkap</label>
                <textarea id="edit_alamat" class="w-full border p-3 rounded-xl bg-gray-50" rows="2">${d.alamat || ''}</textarea>
            </div>
            
            <div class="flex gap-2 pt-4 border-t sticky bottom-0 bg-white">
                <button onclick="saveEdit()" class="flex-1 bg-amber-500 text-white py-4 rounded-xl font-black shadow-lg hover:bg-amber-600 transition-all">üíæ SIMPAN PERUBAHAN</button>
                <button onclick="location.reload()" class="px-6 bg-gray-100 text-gray-500 py-4 rounded-xl font-bold">BATAL</button>
            </div>
        </div>
        `;
            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'Gagal memuat data profil', 'error');
            }
        }

        // Fungsi save EditProfile
        async function saveEdit() {
            Swal.fire({
                title: 'Menyimpan Perubahan...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const payload = {
                no_anggota: document.getElementById('edit_no_anggota').value,
                nama_lengkap: document.getElementById('edit_nama').value,
                nik: document.getElementById('edit_nik').value,
                no_hp: document.getElementById('edit_no_hp').value,
                jenis_kelamin: document.getElementById('edit_jk').value,
                pekerjaan: document.getElementById('edit_pekerjaan').value,
                alamat: document.getElementById('edit_alamat').value,
                // Tgl bergabung ambil dari data awal (tidak diubah)
                tgl_bergabung: currentUserData.tgl_bergabung,
                edit_tempat: document.getElementById('edit_tempat').value,
                edit_tgl_lahir: document.getElementById('edit_tgl_lahir').value
            };

            try {
                const response = await fetch('/api/update-anggota', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Profil Diperbarui!',
                        text: 'Data Anda telah berhasil diupdate.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    location.reload(); // Refresh biar data baru muncul di dashboard
                } else {
                    throw new Error(result.message || "Gagal update data");
                }
            } catch (error) {
                console.error("Error saat save:", error);
                Swal.fire('Gagal!', error.message, 'error');
            }
        }

        async function changePassword() {
            const { value: formValues } = await Swal.fire({
                title: '<span class="text-lg font-black uppercase">Ganti PIN Akses</span>',
                html: `
            <div class="flex flex-col gap-3 p-2">
                <input id="new-pass" class="swal2-input !m-0 !w-full rounded-xl text-sm" placeholder="PIN Baru" type="password">
                <input id="confirm-pass" class="swal2-input !m-0 !w-full rounded-xl text-sm" placeholder="Konfirmasi PIN Baru" type="password">
            </div>
        `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Update PIN',
                confirmButtonColor: '#f59e0b', // Warna Amber-500
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const p1 = document.getElementById('new-pass').value;
                    const p2 = document.getElementById('confirm-pass').value;
                    if (!p1 || !p2) return Swal.showValidationMessage('Isi kedua kolom!');
                    if (p1.length < 6) return Swal.showValidationMessage('PIN minimal 6 karakter!');
                    if (p1 !== p2) return Swal.showValidationMessage('PIN tidak cocok!');
                    return p1;
                }
            });

            if (formValues) {
                // 1. Tampilkan Loading
                Swal.fire({
                    title: 'Sedang Memproses...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    // 2. Kirim data ke Backend
                    const res = await fetch('/api/update-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newPassword: formValues })
                    });

                    const data = await res.json();

                    if (res.ok) {
                        // 3. Jika Berhasil: Munculkan pesan sukses lalu redirect
                        Swal.fire({
                            title: 'Berhasil!',
                            text: 'PIN sudah diganti. Silakan login kembali dengan PIN baru.',
                            icon: 'success',
                            confirmButtonText: 'Ke Halaman Login',
                            confirmButtonColor: '#3b82f6'
                        }).then(() => {
                            // Paksa pindah ke halaman login
                            window.location.href = 'login.html';
                        });
                    } else {
                        // 4. Jika Gagal dari Server (misal sesi habis)
                        throw new Error(data.message || 'Gagal update PIN');
                    }
                } catch (err) {
                    // 5. Jika Error Koneksi/Sistem
                    Swal.fire('Gagal!', err.message, 'error');
                }
            }
        }

        //iklan dulu sebelum logout
        async function handleLogout() {
            let timerInterval;

            Swal.fire({
                title: '<span class="text-[10px] text-gray-400 font-bold tracking-[0.3em] uppercase">Special Info</span>',
                html: `
            <div class="flex flex-col items-center gap-4 p-2">
                <a href="https://wa.me/6281977385582" target="_blank" class="block w-full group overflow-hidden rounded-2xl shadow-lg border border-gray-100">
                    <img src="img/DesainPopUP_fix.png" 
                         alt="PutragungCyber_Dev" 
                         class="w-full h-auto object-cover transform transition-transform duration-700 group-hover:scale-110">
                </a>
                
                <div class="text-center">
                    <p class="text-[11px] text-gray-500 font-medium tracking-tight">
                        Sesi berakhir. Anda akan diarahkan ke login dalam <br>
                        <span class="text-blue-600 font-black text-xl timer-count">5</span> detik
                    </p>
                </div>
            </div>
        `,
                timer: 5000,
                timerProgressBar: true,
                showConfirmButton: false,
                allowOutsideClick: false,
                width: '420px',
                background: '#ffffff',
                didOpen: () => {
                    const b = Swal.getHtmlContainer().querySelector('.timer-count');
                    timerInterval = setInterval(() => {
                        const timeLeft = Swal.getTimerLeft();
                        if (timeLeft) {
                            b.textContent = Math.ceil(timeLeft / 1000);
                        }
                    }, 100);
                },
                willClose: () => {
                    clearInterval(timerInterval);
                }
            }).then(async () => {
                // PROSES LOGOUT ASLI KE ENDPOINT /api/logout
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();
                    if (result.success) {
                        window.location.href = 'login.html';
                    } else {
                        // Jika gagal destroy session, tetap paksa ke login
                        window.location.href = 'login.html';
                    }
                } catch (err) {
                    console.error("Logout error:", err);
                    window.location.href = 'login.html';
                }
            });
        }
    </script>
</body>

</html>