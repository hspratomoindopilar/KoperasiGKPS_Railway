<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Anggota - Koperasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <div class="max-w-lg mx-auto p-4 py-8">
        <div class="bg-white rounded-3xl shadow-2xl p-6 relative">

            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-blue-600 flex items-center gap-2 uppercase tracking-tighter">
                    üë§ Profil Mandiri
                </h3>
                <button onclick="logout()"
                    class="text-[10px] font-bold bg-red-100 text-red-600 px-3 py-1 rounded-full">LOGOUT</button>
            </div>

            <div id="detailContent" class="space-y-4 text-left">
                <div class="flex justify-center items-center p-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
            </div>

            <div class="mt-6 border-t pt-4">
                <p class="text-[9px] text-center text-gray-400 font-bold uppercase tracking-widest">Aplikasi Koperasi
                    v2.0 - 2026</p>
            </div>
        </div>
    </div>
    <div id="kontenLaporanTerpilih" class="hidden fixed inset-0 z-50 bg-gray-100 overflow-y-auto p-4 pb-24">
        <div class="max-w-lg mx-auto flex flex-col gap-4">

            <div class="flex flex-col gap-4 bg-white p-5 rounded-2xl shadow-xl border-2 border-amber-100">
                <div class="flex justify-between items-center">
                    <h2 class="font-black text-amber-700 uppercase text-xs tracking-tighter">üìñ Buku Kendali Iuran Wajib
                    </h2>
                    <button onclick="backToSubMenuLaporan()"
                        class="text-[10px] font-black bg-gray-100 text-gray-500 px-3 py-1 rounded-lg hover:bg-red-50 hover:text-red-600 transition-all">TUTUP</button>
                </div>

                <div class="flex gap-2 items-center">
                    <select id="lapTahun"
                        class="p-3 rounded-xl border-2 border-gray-100 text-xs font-bold flex-1 bg-gray-50 outline-none focus:border-amber-400 transition-all"></select>
                    <button onclick="renderBukuKendaliSaya()"
                        class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded-xl text-xs font-black shadow-md active:scale-95 transition-all italic">PROSES</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 shadow-sm">
                    <p class="text-[9px] uppercase text-emerald-600 font-bold mb-1">Total Lunas</p>
                    <h3 id="statTotalLunas" class="text-sm font-black text-emerald-900">Rp 0</h3>
                </div>
                <div class="p-4 bg-red-50 rounded-2xl border border-red-100 shadow-sm">
                    <p class="text-[9px] uppercase text-red-600 font-bold mb-1">Tunggakan</p>
                    <h3 id="statTotalTunggakan" class="text-sm font-black text-red-900 tracking-tighter">Rp 0</h3>
                </div>
            </div>

            <div class="w-full bg-white rounded-3xl shadow-lg border-2 border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[11px] border-separate border-spacing-0">
                        <thead class="bg-gray-50 text-gray-400 uppercase font-black">
                            <tr>
                                <th class="p-4 border-b">Bulan</th>
                                <th class="p-4 text-center border-b">Status</th>
                                <th class="p-4 text-right border-b bg-gray-50/30">Nominal</th>
                            </tr>
                        </thead>
                        <tbody id="tabelKendaliBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = ''; // Tambahkan ini agar variabelnya terdefinisi
        let idAnggota; // Deklarasikan di atas agar bisa dibaca fungsi lihatRiwayat
        // 1. AMBIL ID DARI SESSION SAAT HALAMAN DIBUKA
        // Karena ini 'anggota.html', kita asumsikan server ngasih data user yang login
        document.addEventListener('DOMContentLoaded', async () => {
            await muatProfilMandiri();
        });

        function formatTglIndo(tgl, tipe = '') {
            if (!tgl) return '-';
            const d = new Date(tgl);
            const opsi = { day: 'numeric', month: 'short', year: 'numeric' };
            const tanggal = d.toLocaleDateString('id-ID', opsi);
            const jam = d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            return tipe === 'jam' ? `${tanggal} ${jam}` : tanggal;
        }

        async function muatProfilMandiri() {
            try {
                const response = await fetch('/api/cek-sesi-anggota');

                // Cek dulu ok atau nggak, baru ambil json-nya
                if (!response.ok) {
                    window.location.href = '/login.html'; // Tambahkan .html jika perlu
                    return;
                }

                const session = await response.json();

                const res = await fetch(`/api/anggota-detail/${session.id_anggota}`);
                const data = await res.json();

                if (res.ok) {
                    idAnggota = data.id_anggota;
                    showDetail(data);
                }
            } catch (err) {
                console.error("Gagal sinkronisasi:", err);
            }
        }

        // 2. FUNGSI "OTAK" (Plek Ketiplek punya Lu)
        function showDetail(d) {
            // --- LOGIKA HITUNG TUNGGAKAN (REVISI HISTORI) ---
            const tglGabung = d.tgl_bergabung ? new Date(d.tgl_bergabung) : new Date();
            const skrg = new Date();

            let totalHarusnya = 0;
            let tempTgl = new Date(tglGabung);
            tempTgl.setDate(1);

            while (tempTgl <= skrg) {
                let bln = tempTgl.getMonth() + 1;
                let thn = tempTgl.getFullYear();
                totalHarusnya += (thn < 2022 || (thn === 2022 && bln < 7)) ? 10000 : 20000;
                tempTgl.setMonth(tempTgl.getMonth() + 1);
            }

            const selisihBulan = (skrg.getFullYear() - tglGabung.getFullYear()) * 12 + (skrg.getMonth() - tglGabung.getMonth()) + 1;
            const sudahBayarBulan = parseInt(d.total_lunas_wajib || 0);
            const nunggakBulan = Math.max(0, selisihBulan - sudahBayarBulan);
            const nunggakNominal = Math.max(0, totalHarusnya - parseInt(d.total_simpanan_wajib_saja || 0));
            const saldoSimpanan = parseInt(d.total_simpanan || 0);

            const boxColor = nunggakBulan > 0 ? "bg-red-50 border-red-100" : "bg-emerald-50 border-emerald-100";
            const textColor = nunggakBulan > 0 ? "text-red-700" : "text-emerald-700";
            const labelColor = nunggakBulan > 0 ? "text-red-400" : "text-emerald-400";

            const tglGabungIndo = d.tgl_bergabung ? new Date(d.tgl_bergabung).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
            const part = (d.ttl || "").split(", ");
            const tempat = part[0] || "-";
            const tglLahirMentah = part[1] || "";
            const tglLahirIndo = tglLahirMentah ? new Date(tglLahirMentah).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : "";
            const ttlCantik = tglLahirIndo !== "" ? `${tempat}, ${tglLahirIndo}` : tempat;

            document.getElementById('detailContent').innerHTML = `
                <div id="viewMode" class="space-y-4">
                    <div class="bg-blue-600 p-5 rounded-2xl text-white shadow-lg mb-4">
                        <p class="text-[10px] font-black uppercase opacity-80">Nama Lengkap Anggota</p>
                        <p class="font-bold text-2xl tracking-tight leading-tight">${d.nama_lengkap}</p>
                        <div class="mt-2 inline-block bg-white/20 px-3 py-1 rounded-full text-[10px] font-bold">ID: ${d.no_anggota}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 p-4 rounded-2xl border ${boxColor} shadow-inner">
                        <div>
                            <p class="text-[9px] font-black ${labelColor} uppercase">Tunggakan Iuran</p>
                            <p class="text-xl font-black ${textColor}">${nunggakBulan} <span class="text-xs font-bold">Bulan</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-black ${labelColor} uppercase">Total Tagihan</p>
                            <p class="text-xl font-black ${textColor}">Rp${nunggakNominal.toLocaleString('id-ID')}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="p-3 rounded-2xl border border-emerald-100 bg-emerald-50 shadow-sm">
                            <p class="text-[9px] font-black text-emerald-400 uppercase">Saldo Simpanan</p>
                            <p class="text-lg font-black text-emerald-700">Rp${saldoSimpanan.toLocaleString('id-ID')}</p>
                            <p class="text-[10px] font-bold text-emerald-600 opacity-70">Wajib + Sukarela</p>
                        </div>
                        <div class="flex items-stretch">
                            <button class="w-full bg-amber-500 text-white rounded-2xl text-[10px] font-black shadow-sm flex flex-col justify-center items-center gap-1">
                                <span class="text-lg">üí∏</span>
                                <span>TARIK SALDO</span>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="p-3 bg-gray-50 rounded-xl border">
                            <p class="text-[9px] font-black text-gray-400 uppercase">Tempat, Tanggal Lahir</p>
                            <p class="font-bold text-gray-700">${ttlCantik}</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-xl border">
                            <p class="text-[9px] font-black text-gray-400 uppercase">Alamat Lengkap</p>
                            <p class="text-sm text-gray-600 leading-relaxed">${d.alamat || '-'}</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 flex justify-between items-center">
                            <div>
                                <p class="text-[9px] font-black text-blue-400 uppercase">Tanggal Bergabung</p>
                                <p class="font-bold text-blue-800">${tglGabungIndo}</p>
                            </div>
                            <span class="bg-emerald-500 text-white text-[10px] px-3 py-1 rounded-full font-bold shadow-sm">AKTIF</span>
                        </div>
                        <div id="areaRiwayat" class="hidden mt-4"></div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 pt-4 border-t">
                        <button class="bg-amber-500 text-white py-2 rounded-xl font-bold text-[10px] shadow-md">‚úèÔ∏è EDIT</button>
                        <button class="bg-red-600 text-white py-2 rounded-xl font-bold text-[10px] shadow-md">üóëÔ∏è HAPUS</button>
                        <button class="bg-emerald-600 text-white py-2 rounded-xl font-bold text-[10px] shadow-md">‚ûï IURAN</button>
                    </div>
                    
                    <button onclick="lihatRiwayat(idAnggota)"class="w-full bg-blue-700 text-white py-3 rounded-xl font-black text-sm shadow-lg mt-2">
                        üìú LIHAT SEMUA RIWAYAT
                    </button>
                    <button onclick="bukaBukuKendali()" class="w-full bg-amber-500 hover:bg-amber-600 text-white py-4 rounded-2xl shadow-lg mt-3 text-[11px] font-black uppercase italic tracking-widest transition-transform active:scale-95 border-b-4 border-amber-700">
                            üìñ Cek Buku Kendali Iuran Wajib
                    </button>
                </div>
            `;
        }
        async function lihatRiwayat(id) { // Nama variabel di sini adalah 'id'
            const area = document.getElementById('areaRiwayat');

            // LOGIKA TOGGLE
            if (!area.classList.contains('hidden')) {
                area.classList.add('hidden');
                return;
            }

            area.innerHTML = '<p class="text-center text-[10px] animate-pulse py-4">Loading...</p>';
            area.classList.remove('hidden');

            try {
                // PERBAIKAN: Ganti ${idAnggota} jadi ${id} agar sesuai dengan parameter di atas
                const res = await fetch(`${API_BASE_URL}/riwayat-iuran/${id}`);
                const data = await res.json();

                let html = `
            <div class="bg-white border-2 border-blue-100 rounded-2xl overflow-hidden shadow-inner mb-4 max-h-[400px] overflow-y-auto">
                <div class="bg-blue-50 p-2 text-[9px] font-bold text-blue-600 flex justify-between uppercase sticky top-0 z-20">
                    <span>Log Transaksi</span>
                    <span>Klik tombol Riwayat lagi untuk tutup</span>
                </div>
                <table class="min-w-full text-[10px] relative">
                    <thead class="bg-gray-100 border-b text-gray-400 sticky top-[25px] z-10 shadow-sm">
                        <tr>
                            <th class="p-2 text-left bg-gray-50">Tgl Input</th>
                            <th class="p-2 text-left bg-gray-50">Periode</th>
                            <th class="p-2 text-right bg-gray-50">Jumlah</th>
                        </tr>
                    </thead>
                <tbody class="divide-y">`;

                data.forEach(t => {
                    const tglSistem = formatTglIndo(t.created_at, 'jam');
                    const nominal = parseFloat(t.jumlah_bayar) || 0;

                    // LOGIKA WARNA & SIMBOL
                    // Kalau nominal minus (< 0), teks jadi merah (rose-600)
                    // Kalau nominal plus (>= 0), teks tetap hijau (emerald-600)
                    const warnaTeks = nominal < 0 ? 'text-rose-600' : 'text-emerald-600';

                    // Kita rapikan tampilannya: Kalau minus, kasih tanda "-" di depan Rp
                    const teksNominal = (nominal < 0 ? '-' : '') + `Rp${Math.abs(nominal).toLocaleString('id-ID')}`;

                    html += `
                <tr class="hover:bg-blue-50">
                    <td class="p-2 text-gray-400 font-mono">${tglSistem}</td>
                    <td class="p-2 font-bold">
                        ${t.bulan_iuran}/${t.tahun_iuran} 
                        <span class="text-[8px] text-gray-400">(${t.jenis_iuran})</span>
                        ${nominal < 0 ? '<br><span class="text-[9px] text-rose-500 font-black">PENGAMBILAN</span>' : ''}
                    </td>
                    <td class="p-2 text-right font-bold ${warnaTeks}">
                        ${teksNominal}
                    </td>
                </tr>`;
                });

                html += `</tbody></table></div>`;
                area.innerHTML = html;

                area.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (e) {
                // Sekarang kalau gagal, kita bisa tau errornya di console (F12)
                console.error("Detail Error Riwayat:", e);
                area.innerHTML = '<p class="text-red-500 text-xs text-center">Gagal load data. Cek koneksi API.</p>';
            }
        }

        function generateTahunFilter() {
            const sel = document.getElementById('lapTahun');
            if (!sel) return;
            const now = new Date().getFullYear();
            sel.innerHTML = '';
            // Review tahun 2013 sampai tahun depan
            for (let i = now + 1; i >= 2013; i--) {
                sel.insertAdjacentHTML('beforeend', `<option value="${i}" ${i === now ? 'selected' : ''}>TAHUN ${i}</option>`);
            }
        }

        async function renderBukuKendaliSaya() {
            const thn = document.getElementById('lapTahun').value;
            const tbody = document.getElementById('tabelKendaliBody');
            const now = new Date();

            tbody.innerHTML = '<tr><td colspan="3" class="p-10 text-center animate-pulse text-amber-500 font-bold">Sinkronisasi...</td></tr>';

            try {
                const [resMe, resLaporan] = await Promise.all([
                    fetch('/api/auth/me'),
                    fetch(`/api/laporan-transaksi?tahun=${thn}&v=${Date.now()}`)
                ]);

                const me = await resMe.json();
                const dataLap = await resLaporan.json();
                const config = dataLap.config || {};
                const dataTrans = dataLap.transaksi || [];
                const nominalWajib = config.iuran_wajib || 20000;

                const blnBerjalan = (thn == now.getFullYear()) ? now.getMonth() + 1 : (thn < now.getFullYear() ? 12 : 0);
                const tglGabung = new Date(me.tgl_bergabung);

                tbody.innerHTML = '';

                ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"].forEach((nama, i) => {
                    const b = i + 1;
                    const ada = dataTrans.find(t => t.id_anggota === me.id_anggota && t.bulan_iuran === b && t.jenis_iuran === 'wajib');

                    let status = "N/A", style = "text-gray-200 italic", bayar = "Rp 0";
                    const sudahWajib = (thn > tglGabung.getFullYear()) || (thn == tglGabung.getFullYear() && b >= (tglGabung.getMonth() + 1));

                    if (ada) {
                        status = "LUNAS";
                        style = "text-emerald-600 font-black bg-emerald-50/50";
                        bayar = `Rp${parseFloat(ada.jumlah_bayar).toLocaleString('id-ID')}`;
                    } else if (sudahWajib && b <= blnBerjalan) {
                        status = "NUNGGAK";
                        style = "text-red-500 font-black bg-red-50";
                    }

                    tbody.insertAdjacentHTML('beforeend', `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 border-b font-bold">${nama}</td>
                    <td class="p-4 border-b text-center text-[9px] ${style}">${status}</td>
                    <td class="p-4 border-b text-right font-black">${bayar}</td>
                </tr>
            `);
                });
            } catch (e) { tbody.innerHTML = '<tr><td colspan="3" class="p-5 text-center text-red-500">Gagal Sinkron.</td></tr>'; }
        }

        function bukaBukuKendali() {
            document.getElementById('kontenLaporanTerpilih').classList.remove('hidden');
            generateTahunFilter();
            renderBukuKendaliSaya();
        }

        function backToSubMenuLaporan() {
            document.getElementById('kontenLaporanTerpilih').classList.add('hidden');
        }


        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST', // WAJIB POST sesuai index.js lu
                    headers: { 'Content-Type': 'application/json' }
                });

                const hasil = await response.json();
                if (hasil.success) {
                    // Hapus jejak di browser dan balik ke login
                    window.location.href = '/login.html';
                }
            } catch (err) {
                console.error("Gagal logout:", err);
                // Tetap paksa pindah jika error
                window.location.href = '/login.html';
            }
        }
    </script>
</body>

</html>